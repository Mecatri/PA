<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Atividades Firestore + Login</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f6f7fb; }
    table { border-collapse: collapse; width: 90%; margin: 20px auto; }
    th, td { border: 1px solid #aaa; padding: 8px; text-align: center; }
    input, select { width: 95%; }
    button { margin: 2px 5px; }
    .popup {
      display: none; position: fixed; z-index: 9; left: 0; top: 0; width: 100vw;
      height: 100vh; background: rgba(0,0,0,0.4); justify-content: center; align-items: center;
    }
    .popup-content {
      background: #fff; padding: 30px 50px; border-radius: 10px; text-align: center; font-size: 18px;
      box-shadow: 0 2px 10px #3336;
    }
    .editando { background: #ffffe0; }
    #loginBox {
      display: flex; flex-direction: column; align-items: center; margin-top: 10vh; background: #fff;
      padding: 40px 30px; border-radius: 10px; box-shadow: 0 2px 10px #3331; width: 350px; margin-left: auto; margin-right: auto;
    }
    #logoutBtn {
      float: right; margin: 10px 5vw 0 0; background: #c22; color: #fff; border: none; padding: 7px 15px; border-radius: 5px;
    }
  </style>
</head>
<body>
  <div id="loginBox" style="display:none;">
    <h2>Login</h2>
    <input type="email" id="loginEmail" placeholder="E-mail"><br>
    <input type="password" id="loginPass" placeholder="Senha"><br>
    <button onclick="fazerLogin()">Entrar</button>
    <div id="loginMsg" style="color: red; margin-top: 8px;"></div>
  </div>

  <button id="logoutBtn" onclick="logout()" style="display:none;">Sair</button>

  <div id="conteudo" style="display:none;">
    <h2 style="text-align:center;">Cadastro de Atividades (Firestore)</h2>
    <table>
      <tr>
        <th>Nome da Atividade</th>
        <th>Duração (horas)</th>
        <th>Início</th>
        <th>Fim</th>
        <th>Status</th>
        <th>Ação</th>
      </tr>
      <tr>
        <td><input type="text" id="nomeAtividade"></td>
        <td><input type="number" id="duracao"></td>
        <td><input type="datetime-local" id="inicio"></td>
        <td><input type="datetime-local" id="fim"></td>
        <td>
          <select id="status">
            <option value="em_andamento">Em andamento</option>
            <option value="concluida">Concluída</option>
            <option value="atrasada">Atrasada</option>
          </select>
        </td>
        <td><button onclick="salvarAtividade()">Salvar</button></td>
      </tr>
    </table>
    <div id="mensagem" style="text-align:center;color:green;"></div>
    
    <!-- POPUP de Confirmação -->
    <div id="popup" class="popup" onclick="fecharPopup()">
      <div class="popup-content" onclick="event.stopPropagation();">
        <span id="popupMsg">Atividade salva com sucesso!</span><br>
        <button onclick="fecharPopup()">OK</button>
      </div>
    </div>

    <h3 style="text-align:center;">Histórico de Atividades</h3>
    <div id="historicoContainer" style="display: flex; justify-content: center;">
      <table id="historicoTable" style="width:90%;">
        <thead>
          <tr>
            <th>Nome da Atividade</th>
            <th>Duração</th>
            <th>Início</th>
            <th>Fim</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="historicoBody">
          <!-- Linhas do histórico -->
        </tbody>
      </table>
    </div>
  </div>
</body>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script>
  // Configuração do Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCaZC2E6EpcC8Xl4lOTDQA3n3lMTP6NxwQ",
    authDomain: "pa-pg-a7abc.firebaseapp.com",
    projectId: "pa-pg-a7abc",
    storageBucket: "pa-pg-a7abc.appspot.com",
    messagingSenderId: "102164980919",
    appId: "1:102164980919:web:72220a8b2ed478a2cdd932"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let editandoId = null; // Se estiver editando, guarda o ID do documento

  function mostrarLogin() {
    document.getElementById('loginBox').style.display = 'block';
    document.getElementById('conteudo').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'none';
  }
  function mostrarConteudo() {
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('conteudo').style.display = 'block';
    document.getElementById('logoutBtn').style.display = 'block';
  }
  function fazerLogin() {
    const email = document.getElementById('loginEmail').value;
    const senha = document.getElementById('loginPass').value;
    document.getElementById('loginMsg').innerText = '';
    auth.signInWithEmailAndPassword(email, senha)
      .then(() => {
        mostrarConteudo();
        carregarHistorico();
      })
      .catch((error) => {
        document.getElementById('loginMsg').innerText = "Usuário ou senha inválidos";
      });
  }
  function logout() {
    auth.signOut().then(() => {
      mostrarLogin();
      limparCampos();
      document.getElementById('historicoBody').innerHTML = '';
    });
  }
  auth.onAuthStateChanged((user) => {
    if(user) {
      mostrarConteudo();
      carregarHistorico();
    } else {
      mostrarLogin();
    }
  });

  function salvarAtividade() {
    const nome = document.getElementById('nomeAtividade').value;
    const duracao = document.getElementById('duracao').value;
    const inicio = document.getElementById('inicio').value;
    const fim = document.getElementById('fim').value;
    const status = document.getElementById('status').value;

    if (!nome || !duracao || !inicio || !fim || !status) {
      document.getElementById('mensagem').style.color = 'red';
      document.getElementById('mensagem').innerText = 'Preencha todos os campos!';
      return;
    }

    const novaAtividade = { nome, duracao, inicio, fim, status };

    if(editandoId) {
      db.collection('atividades').doc(editandoId).set(novaAtividade)
      .then(() => {
        mostrarPopup('Atividade editada com sucesso!');
        limparCampos();
      })
      .catch((error) => {
        document.getElementById('mensagem').style.color = 'red';
        document.getElementById('mensagem').innerText = 'Erro ao salvar!';
      });
    } else {
      db.collection('atividades').add(novaAtividade)
      .then(() => {
        mostrarPopup('Atividade salva com sucesso!');
        limparCampos();
      })
      .catch((error) => {
        document.getElementById('mensagem').style.color = 'red';
        document.getElementById('mensagem').innerText = 'Erro ao salvar!';
      });
    }
  }

  function mostrarPopup(msg) {
    document.getElementById('popupMsg').innerText = msg;
    document.getElementById('popup').style.display = 'flex';
  }

  function fecharPopup() {
    document.getElementById('popup').style.display = 'none';
    document.getElementById('mensagem').innerText = '';
  }

  function limparCampos() {
    document.getElementById('nomeAtividade').value = '';
    document.getElementById('duracao').value = '';
    document.getElementById('inicio').value = '';
    document.getElementById('fim').value = '';
    document.getElementById('status').value = 'em_andamento';
    editandoId = null;
    document.querySelectorAll(".editando").forEach(row => row.classList.remove("editando"));
  }

  let unsubscribeHistorico = null;
  function carregarHistorico() {
    if(unsubscribeHistorico) unsubscribeHistorico();
    unsubscribeHistorico = db.collection('atividades').orderBy("inicio", "desc").onSnapshot((snapshot) => {
      let tbody = document.getElementById('historicoBody');
      tbody.innerHTML = '';
      snapshot.forEach((doc) => {
        const atividade = doc.data();
        const key = doc.id;
        const tr = document.createElement('tr');
        if(editandoId === key) tr.className = "editando";
        tr.innerHTML = `
          <td>${atividade.nome}</td>
          <td>${atividade.duracao}</td>
          <td>${atividade.inicio?.replace('T',' ')}</td>
          <td>${atividade.fim?.replace('T',' ')}</td>
          <td>${formatarStatus(atividade.status)}</td>
          <td>
            <button onclick="editarAtividade('${key}')">Editar</button>
            <button onclick="excluirAtividade('${key}')">Excluir</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    });
  }

  function editarAtividade(id) {
    db.collection('atividades').doc(id).get().then((doc) => {
      if (doc.exists) {
        const atividade = doc.data();
        document.getElementById('nomeAtividade').value = atividade.nome;
        document.getElementById('duracao').value = atividade.duracao;
        document.getElementById('inicio').value = atividade.inicio;
        document.getElementById('fim').value = atividade.fim;
        document.getElementById('status').value = atividade.status;
        editandoId = id;
        document.getElementById('mensagem').style.color = 'blue';
        document.getElementById('mensagem').innerText = 'Editando atividade. Altere os campos e clique em Salvar.';
        document.querySelectorAll("#historicoBody tr").forEach(row => row.classList.remove("editando"));
        // Destaca a linha em edição
        let linhas = document.querySelectorAll("#historicoBody tr");
        linhas.forEach((row, idx) => {
          if(editandoId === id) row.classList.add("editando");
        });
      }
    });
  }

  function excluirAtividade(id) {
    if(confirm('Tem certeza que deseja excluir esta atividade?')) {
      db.collection('atividades').doc(id).delete();
      if(editandoId === id) limparCampos();
    }
  }

  function formatarStatus(status) {
    if(status === 'concluida')
      return '<span style="color:green;font-weight:bold;">Concluída</span>';
    if(status === 'em_andamento')
      return '<span style="color:blue;font-weight:bold;">Em andamento</span>';
    if(status === 'atrasada')
      return '<span style="color:red;font-weight:bold;">Atrasada</span>';
    return status;
  }

  // No início, mostra login se não autenticado
  window.onload = function() {
    auth.onAuthStateChanged((user) => {
      if(user) {
        mostrarConteudo();
        carregarHistorico();
      } else {
        mostrarLogin();
      }
    });
  }
</script>
</html>
