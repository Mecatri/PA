<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Controle de Gastos - Casamento ¬∑ Mobile (Compartilhado)</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
/* (Mantive o estilo mobile-first otimizado do arquivo anterior) */
:root{
    --bg:#fbfaf7;--card:#ffffff;--muted:#6b6b6b;--accent:#8B5E3C;--accent-2:#D9B873;
    --success:#3a9d56;--danger:#c9302c;--warn:#c87f00;--shadow:0 8px 24px rgba(22,22,22,0.08);
}
*{box-sizing:border-box;}html,body{height:100%;}
body{margin:0;font-family:'Poppins',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:linear-gradient(180deg,#fbfaf7 0%,#fffefc 100%);color:#222;padding:12px;-webkit-tap-highlight-color:transparent;}
.container{max-width:460px;margin:0 auto;background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(255,255,255,0.96));
    border-radius:16px;padding:14px;box-shadow:var(--shadow);}
.header{text-align:center;margin-bottom:10px;}
.header h1{margin:0;font-family:'Playfair Display',serif;font-size:1.25rem;color:var(--accent);line-height:1.1;}
.header p{margin:6px 0 0;color:var(--muted);font-size:0.9rem;}
.summary{display:flex;gap:10px;overflow-x:auto;padding-bottom:6px;margin:12px 0;}
.card{background:var(--card);border-radius:12px;padding:10px 12px;box-shadow:0 6px 18px rgba(20,20,20,0.03);
    min-width:150px;display:flex;flex-direction:column;gap:6px;flex:0 0 auto;}
.card .label{font-weight:700;color:var(--muted);font-size:0.83rem;}
.card .value{font-weight:800;font-size:1rem;color:var(--accent);}
.btn-primary{background:linear-gradient(90deg,var(--accent-2),#cd9f52);border:none;color:#fff;padding:12px 14px;border-radius:12px;
    font-weight:800;cursor:pointer;box-shadow:0 6px 14px rgba(205,159,82,0.16);font-size:1rem;min-height:48px;width:100%;}
.btn-clear{background:#f5f5f5;border-radius:10px;padding:10px 12px;border:1px solid #eee;cursor:pointer;font-weight:700;}
.form{background:linear-gradient(180deg,#fff,#fbfbfb);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px;
    box-shadow:0 6px 14px rgba(18,18,18,0.03);margin-bottom:10px;}
.input,select{padding:12px 14px;border-radius:10px;border:1px solid #e6e6e6;font-size:1rem;background:#fff;width:100%;}
.form-actions{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
.table-wrap{margin-top:8px;}table{width:100%;border-collapse:collapse;}thead{display:none;}tbody{display:block;}
tr{display:block;margin:10px 0;background:#fff;border-radius:12px;padding:10px;box-shadow:0 6px 18px rgba(10,10,10,0.03);}
td{display:flex;justify-content:space-between;padding:6px 0;border:none;font-size:0.95rem;align-items:center;}
td::before{content:attr(data-label);font-weight:700;color:var(--muted);margin-right:8px;width:40%;font-size:0.9rem;}
.row-action{display:flex;flex-direction:column;gap:8px;margin-top:6px;}
.btn-small{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;font-size:0.95rem;width:100%;text-align:center;}
.btn-edit{background:#fff7ec;color:#8b5e3c;border:1px solid #fdeed8;}
.btn-delete{background:#fff0f0;color:var(--danger);border:1px solid #ffecec;}
.alert-orange td{background:#fff7ee;color:var(--warn);font-weight:700;border-radius:8px;}
.alert-red td{background:#fff0f0;color:var(--danger);font-weight:700;border-radius:8px;}
.modal-backdrop{position:fixed;inset:0;background:rgba(10,10,10,0.45);display:none;align-items:flex-end;justify-content:center;z-index:999;}
.modal{background:var(--card);border-top-left-radius:16px;border-top-right-radius:16px;padding:16px;width:100%;max-height:92vh;overflow:auto;box-shadow:0 -6px 24px rgba(20,20,20,0.18);}
.modal h3{margin:0 0 8px;color:var(--accent);font-family:'Playfair Display',serif;} .modal .row{display:flex;flex-direction:column;gap:8px;margin-bottom:10px;}
.small{font-size:0.85rem;color:var(--muted);} .sr-only{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
@media(min-width:880px){ /* manuten√ß√£o opcional desktop */ }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üíç Controle de Gastos do Casamento</h1>
        <p class="small">Compartilhado em tempo real ‚Äî todos veem e podem editar.</p>
    </div>

    <section class="summary" aria-hidden="false">
        <div class="card pago"><div class="label">Pago ‚Äî Noivo</div><div class="value" id="total-pago-noivo">R$ 0,00</div></div>
        <div class="card pago"><div class="label">Pago ‚Äî Noiva</div><div class="value" id="total-pago-noiva">R$ 0,00</div></div>
        <div class="card geral"><div class="label">Total Pago</div><div class="value" id="total-pago-geral">R$ 0,00</div></div>
        <div class="card apagar"><div class="label">A Pagar ‚Äî Noivo</div><div class="value" id="total-apagar-noivo">R$ 0,00</div></div>
        <div class="card apagar"><div class="label">A Pagar ‚Äî Noiva</div><div class="value" id="total-apagar-noiva">R$ 0,00</div></div>
        <div class="card apagar"><div class="label">Total a Pagar</div><div class="value" id="total-apagar-geral">R$ 0,00</div></div>
    </section>

    <form id="form" class="form" autocomplete="off">
        <input id="item" class="input" type="text" placeholder="Item" required />
        <input id="valor" class="input" type="number" min="0" step="0.01" placeholder="Valor (R$)" required />
        <select id="status" class="input" required>
            <option value="" disabled selected>Status</option>
            <option value="Pago">Pago</option>
            <option value="A Pagar">A Pagar</option>
        </select>
        <select id="responsavel" class="input" required>
            <option value="" disabled selected>Respons√°vel</option>
            <option value="Noivo">Noivo</option>
            <option value="Noiva">Noiva</option>
        </select>
        <input id="data" class="input" type="date" placeholder="Data" />
        <div class="form-actions" style="width:100%;">
            <button type="submit" class="btn-primary">Adicionar Gasto</button>
            <div style="display:flex;gap:8px;">
                <button type="button" id="export-csv" class="btn-clear">Exportar</button>
                <button type="button" id="clear-all" class="btn-clear">Limpar</button>
            </div>
        </div>
    </form>

    <div class="table-wrap" role="region" aria-label="Lista de gastos">
        <table id="tabela" aria-describedby="lista-desc">
            <thead><tr><th>Item</th><th>Valor</th><th>Status</th><th>Respons√°vel</th><th>Data</th><th>A√ß√µes</th></tr></thead>
            <tbody></tbody>
        </table>
        <div id="lista-desc" class="small" style="margin-top:8px;color:var(--muted)">
            Dados compartilhados em tempo real. Qualquer altera√ß√£o √© vis√≠vel a todos.
        </div>
    </div>
</div>

<div class="modal-backdrop" id="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-title">
        <h3 id="edit-title">Editar Lan√ßamento</h3>
        <div class="row"><label class="small" for="edit-item">Item</label><input id="edit-item" class="input" type="text" /></div>
        <div class="row"><label class="small" for="edit-valor">Valor</label><input id="edit-valor" class="input" type="number" min="0" step="0.01" /></div>
        <div class="row"><label class="small" for="edit-status">Status</label><select id="edit-status" class="input"><option>Pago</option><option>A Pagar</option></select></div>
        <div class="row"><label class="small" for="edit-resp">Respons√°vel</label><select id="edit-resp" class="input"><option>Noivo</option><option>Noiva</option></select></div>
        <div class="row"><label class="small" for="edit-data">Data</label><input id="edit-data" class="input" type="date" /></div>
        <div style="display:flex;gap:10px;justify-content:space-between;margin-top:8px;">
            <button id="cancel-edit" class="btn-clear">Cancelar</button>
            <button id="save-edit" class="btn-primary">Salvar</button>
        </div>
    </div>
</div>

<!-- Firebase SDKs (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
/*
  Integra√ß√£o Firestore:
  - Este script conecta a sua p√°gina ao Firestore e salva/edita/remove lan√ßamentos na cole√ß√£o "gastos".
  - Substitu√≠ o placeholder do firebaseConfig pelo seu projeto (dispesas-9082a), use regras seguras no Firestore.
  - Para testes r√°pidos, voc√™ pode permitir read/write temporariamente nas regras (n√£o recomendado em produ√ß√£o).
*/

const firebaseConfig = {
  apiKey: "AIzaSyBjncnSGojzX6WumANGgQDrzYWnU696YCQ",
  authDomain: "dispesas-9082a.firebaseapp.com",
  projectId: "dispesas-9082a",
  storageBucket: "dispesas-9082a.firebasestorage.app",
  messagingSenderId: "574298243285",
  appId: "1:574298243285:web:78f35eccfe8ae37a3ba25c",
  measurementId: "G-EXMCETLB5N"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let gastos = []; // array local espelho
const ids = {
    tabelaBody: document.querySelector('#tabela tbody'),
    totalPagoNoivo: document.getElementById('total-pago-noivo'),
    totalPagoNoiva: document.getElementById('total-pago-noiva'),
    totalPagoGeral: document.getElementById('total-pago-geral'),
    totalApagarNoivo: document.getElementById('total-apagar-noivo'),
    totalApagarNoiva: document.getElementById('total-apagar-noiva'),
    totalApagarGeral: document.getElementById('total-apagar-geral'),
    form: document.getElementById('form'),
    itemIn: document.getElementById('item'),
    valorIn: document.getElementById('valor'),
    statusIn: document.getElementById('status'),
    respIn: document.getElementById('responsavel'),
    dataIn: document.getElementById('data'),
    modalBackdrop: document.getElementById('modal-backdrop'),
    editItem: document.getElementById('edit-item'),
    editValor: document.getElementById('edit-valor'),
    editStatus: document.getElementById('edit-status'),
    editResp: document.getElementById('edit-resp'),
    editData: document.getElementById('edit-data'),
    saveEditBtn: document.getElementById('save-edit'),
    cancelEditBtn: document.getElementById('cancel-edit'),
    exportCsvBtn: document.getElementById('export-csv'),
    clearAllBtn: document.getElementById('clear-all')
};

function formatBRL(v){ return Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
function escapeCsv(s){ if(s==null) return ''; s=String(s); if(s.includes('"')||s.includes(',')||s.includes('\n')||s.includes('\r')) return '"' + s.replace(/"/g,'""') + '"'; return s; }

function render(){
    ids.tabelaBody.innerHTML = '';
    let pagoNoivo = 0, pagoNoiva = 0, apagarNoivo = 0, apagarNoiva = 0;
    const hoje = new Date(); hoje.setHours(0,0,0,0);

    gastos.forEach((g, idx) => {
        const val = Number(g.valor||0);
        if (g.status === "Pago") {
            if (g.responsavel === "Noivo") pagoNoivo += val;
            else if (g.responsavel === "Noiva") pagoNoiva += val;
        } else {
            if (g.responsavel === "Noivo") apagarNoivo += val;
            else if (g.responsavel === "Noiva") apagarNoiva += val;
        }

        const tr = document.createElement('tr');
        let alertClass = '';
        if (g.status === "A Pagar" && g.data) {
            const dt = new Date(g.data); dt.setHours(0,0,0,0);
            const diffDays = Math.ceil((dt - hoje) / (1000 * 60 * 60 * 24));
            if (diffDays < 0) alertClass = 'alert-red';
            else if (diffDays <= 7) alertClass = 'alert-orange';
        }
        if (alertClass) tr.classList.add(alertClass);

        tr.innerHTML = `
            <td data-label="Item"><span>${escapeHtml(g.item)}</span></td>
            <td data-label="Valor"><span>${formatBRL(g.valor)}</span></td>
            <td data-label="Status"><span>${escapeHtml(g.status)}</span></td>
            <td data-label="Respons√°vel"><span>${escapeHtml(g.responsavel)}</span></td>
            <td data-label="Data"><span>${g.data ? (new Date(g.data)).toLocaleDateString('pt-BR') : '-'}</span></td>
            <td data-label="A√ß√µes">
                <div class="row-action">
                    <button class="btn-small btn-edit" type="button" data-id="${g._id}">Editar</button>
                    <button class="btn-small btn-delete" type="button" data-id="${g._id}">Remover</button>
                </div>
            </td>`;
        ids.tabelaBody.appendChild(tr);
    });

    ids.totalPagoNoivo.textContent = formatBRL(pagoNoivo);
    ids.totalPagoNoiva.textContent = formatBRL(pagoNoiva);
    ids.totalPagoGeral.textContent = formatBRL(pagoNoivo + pagoNoiva);
    ids.totalApagarNoivo.textContent = formatBRL(apagarNoivo);
    ids.totalApagarNoiva.textContent = formatBRL(apagarNoiva);
    ids.totalApagarGeral.textContent = formatBRL(apagarNoivo + apagarNoiva);

    // bind action buttons (delegation simple)
    ids.tabelaBody.querySelectorAll('.btn-delete').forEach(btn=>{
        btn.onclick = ()=> removeItem(btn.dataset.id);
    });
    ids.tabelaBody.querySelectorAll('.btn-edit').forEach(btn=>{
        btn.onclick = ()=> openEditModal(btn.dataset.id);
    });
}

/* --- Firestore real-time listener --- */
const gastosQuery = db.collection('gastos').orderBy('createdAt', 'asc');

gastosQuery.onSnapshot(snapshot => {
    const arr = [];
    snapshot.forEach(doc => {
        const d = doc.data();
        arr.push({
            _id: doc.id,
            item: d.item || '',
            valor: Number(d.valor || 0),
            status: d.status || 'A Pagar',
            responsavel: d.responsavel || 'Noivo',
            data: d.data || '',
            createdAt: d.createdAt ? d.createdAt.toDate?.() || d.createdAt : null
        });
    });
    gastos = arr;
    render();
}, err => {
    console.error('Erro ao escutar Firestore:', err);
});

/* Adicionar novo gasto (grava no Firestore) */
ids.form.addEventListener('submit', ev=>{
    ev.preventDefault();
    const item = ids.itemIn.value.trim();
    const valor = parseFloat(ids.valorIn.value);
    const status = ids.statusIn.value;
    const resp = ids.respIn.value;
    const data = ids.dataIn.value || '';

    if(!item || isNaN(valor) || valor <= 0 || !status || !resp) return alert('Preencha todos os campos.');
    if(status === 'A Pagar' && !data) return alert('Informe a data para "A Pagar".');

    db.collection('gastos').add({
        item,
        valor: Number(valor.toFixed(2)),
        status,
        responsavel: resp,
        data,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>{
        ids.form.reset();
        // UI ser√° atualizado pelo listener onSnapshot
    }).catch(err=>{
        console.error('Erro ao adicionar:', err);
        alert('N√£o foi poss√≠vel adicionar. Tente novamente.');
    });
});

/* Remover por id */
function removeItem(id){
    if(!id) return;
    if(!confirm('Remover este lan√ßamento?')) return;
    db.collection('gastos').doc(id).delete().catch(err=>{
        console.error('Erro ao remover:', err);
        alert('Falha ao remover.');
    });
}

/* Edi√ß√£o: abrir modal com dados do doc */
let editingId = null;
function openEditModal(id){
    if(!id) return;
    editingId = id;
    db.collection('gastos').doc(id).get().then(doc=>{
        if(!doc.exists) return alert('Lan√ßamento n√£o encontrado (pode ter sido removido).');
        const d = doc.data();
        ids.editItem.value = d.item || '';
        ids.editValor.value = d.valor || 0;
        ids.editStatus.value = d.status || 'A Pagar';
        ids.editResp.value = d.responsavel || 'Noivo';
        ids.editData.value = d.data || '';
        ids.modalBackdrop.style.display = 'flex';
        ids.modalBackdrop.setAttribute('aria-hidden','false');
        ids.editItem.focus();
    }).catch(err=>{
        console.error('Erro ao carregar documento:', err);
        alert('Erro ao carregar para edi√ß√£o.');
    });
}

/* Salvar edi√ß√£o */
ids.saveEditBtn.onclick = ()=>{
    if(!editingId) return;
    const item = ids.editItem.value.trim();
    const valor = parseFloat(ids.editValor.value);
    const status = ids.editStatus.value;
    const resp = ids.editResp.value;
    const data = ids.editData.value || '';

    if(!item || isNaN(valor) || valor <= 0 || !status || !resp) return alert('Preencha todos os campos.');
    if(status === 'A Pagar' && !data) return alert('Informe a data para "A Pagar".');

    db.collection('gastos').doc(editingId).update({
        item,
        valor: Number(valor.toFixed(2)),
        status,
        responsavel: resp,
        data,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>{
        editingId = null;
        ids.modalBackdrop.style.display = 'none';
        ids.modalBackdrop.setAttribute('aria-hidden','true');
    }).catch(err=>{
        console.error('Erro ao salvar edi√ß√£o:', err);
        alert('Falha ao salvar altera√ß√µes.');
    });
};

/* Cancelar edi√ß√£o */
ids.cancelEditBtn.onclick = ()=>{
    editingId = null;
    ids.modalBackdrop.style.display = 'none';
    ids.modalBackdrop.setAttribute('aria-hidden','true');
};

/* Export CSV - gera a partir do array local (j√° sincronizado) */
ids.exportCsvBtn.onclick = ()=>{
    if(!gastos.length) return alert('Nenhum lan√ßamento para exportar.');
    const headers = ['Item','Valor','Status','Respons√°vel','Data'];
    const rows = gastos.map(g => [
        escapeCsv(g.item),
        (Number(g.valor||0)).toFixed(2),
        g.status,
        g.responsavel,
        g.data || ''
    ]);
    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\r\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'gastos_casamento_shared.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};

/* Limpar todos: apagar todos os docs da cole√ß√£o (perigoso em produ√ß√£o) */
ids.clearAllBtn.onclick = async ()=>{
    if(!confirm('Remover todos os lan√ßamentos? Esta a√ß√£o apagar√° todos os registros para todos os usu√°rios.')) return;
    try{
        const snap = await db.collection('gastos').get();
        const batch = db.batch();
        snap.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        alert('Todos os lan√ßamentos removidos.');
    }catch(err){
        console.error('Erro ao limpar todos:', err);
        alert('Falha ao limpar.');
    }
};

/* Escuta ESC para fechar modal */
document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
        editingId = null;
        ids.modalBackdrop.style.display = 'none';
        ids.modalBackdrop.setAttribute('aria-hidden','true');
    }
});

/* clique no backdrop fecha modal */
ids.modalBackdrop.addEventListener('click', (ev)=>{
    if(ev.target === ids.modalBackdrop){
        editingId = null;
        ids.modalBackdrop.style.display = 'none';
        ids.modalBackdrop.setAttribute('aria-hidden','true');
    }
});
</script>
</body>
</html>
