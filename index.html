// Configuração do Firebase (mantenha a sua)
    const firebaseConfig = {
      apiKey: "AIzaSyCaZC2E6EpcC8Xl4lOTDQA3n3lMTP6NxwQ",
      authDomain: "pa-pg-a7abc.firebaseapp.com",
      projectId: "pa-pg-a7abc",
      storageBucket: "pa-pg-a7abc.firebasestorage.app",
      messagingSenderId: "102164980919",
      appId: "1:102164980919:web:72220a8b2ed478a2cdd932",
      clientId: "460190166657-18jbdvae4cemj3n38ivsnol1r975nkee.apps.googleusercontent.com"
    };

    // Inicialize o Firebase (mantenha a sua)
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Função de login com Gmail (mantenha a sua)
    function login() {
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({ client_id: firebaseConfig.clientId });

      auth.signInWithPopup(provider)
        .then((result) => {
          console.log("Usuário logado:", result.user);
          document.getElementById("login").style.display = "none";
          document.getElementById("app").style.display = "block";
          document.getElementById("loginMessage").textContent = "";
          mostrarHistorico();
        })
        .catch((error) => {
          console.error("Erro no login:", error);
          document.getElementById("loginMessage").textContent = "Erro no login: " + error.message;
        });
    }

    // Função de logout (mantenha a sua)
    function logout() {
      auth.signOut()
        .then(() => {
          console.log("Usuário deslogado");
          document.getElementById("login").style.display = "block";
          document.getElementById("app").style.display = "none";
        })
        .catch((error) => {
          console.error("Erro ao sair:", error);
        });
    }

    // Verificar estado de autenticação (mantenha a sua)
    auth.onAuthStateChanged((user) => {
      if (user) {
        console.log("Usuário autenticado:", user);
        document.getElementById("login").style.display = "none";
        document.getElementById("app").style.display = "block";
        mostrarHistorico();
      } else {
        console.log("Nenhum usuário autenticado");
        document.getElementById("login").style.display = "block";
        document.getElementById("app").style.display = "none";
      }
    });

    // Função para gerar QR Code
    async function gerarQRCode() {
      if (!auth.currentUser) {
        alert("Você precisa estar logado para realizar esta ação.");
        return;
      }

      const descricao = document.getElementById("descricao").value.trim();
      const inicio = document.getElementById("inicio").value;
      const fim = document.getElementById("fim").value;
      const mensagem = document.getElementById("mensagem");
      const qrcodeContainer = document.getElementById("qrcode");
      qrcodeContainer.innerHTML = "";
      const canvas = document.createElement("canvas");
      qrcodeContainer.appendChild(canvas);

      if (!descricao || !inicio || !fim) {
        mensagem.textContent = "Por favor, preencha todos os campos.";
        return;
      }

      if (new Date(inicio) >= new Date(fim)) {
        mensagem.textContent = "A data de início deve ser anterior à data de término.";
        return;
      }

      mensagem.textContent = "";

      // URL da página do formulário com parâmetros
      const url = `https://mecatri.github.io/PA/formulario.html?descricao=${encodeURIComponent(descricao)}&inicio=${encodeURIComponent(inicio)}&fim=${encodeURIComponent(fim)}`;

      try {
        // Gerar QR Code como Data URL
        QRCode.toDataURL(url, async function (error, dataUrl) {
          if (error) {
            console.error(error);
            qrcodeContainer.innerHTML = "<p>Erro ao gerar QR Code</p>";
            return;
          }

          const link = document.createElement("p");
          link.innerHTML = `Link gerado: <a href="${url}" target="_blank">${url}</a><br><strong>${descricao}</strong>`;
          qrcodeContainer.appendChild(link);

          const img = document.createElement("img");
          img.src = dataUrl;
          img.style.maxWidth = "200px";
          qrcodeContainer.appendChild(img);

          // Salvar no Firestore (incluindo a dataUrl do QR Code)
          const atividade = { descricao, inicio, fim, url, qrCodeUrl: dataUrl, userId: auth.currentUser.uid };
          try {
            const docRef = await db.collection("historico").add(atividade);
            console.log("Atividade salva no Firebase com ID:", docRef.id);
            mostrarHistorico();
          } catch (error) {
            console.error("Erro ao salvar atividade:", error);
          }
        });
      } catch (error) {
        console.error("Erro ao gerar QR Code:", error);
        qrcodeContainer.innerHTML = "<p>Erro ao gerar QR Code</p>";
      }
    }

    // Função para mostrar histórico
    async function mostrarHistorico() {
      const lista = document.getElementById("listaAtividades");
      lista.innerHTML = "";

      if (!auth.currentUser) {
        alert("Você precisa estar logado para acessar o histórico.");
        return;
      }

      try {
        const querySnapshot = await db.collection("historico").where("userId", "==", auth.currentUser.uid).get();
        if (querySnapshot.empty) {
          lista.innerHTML = "<p>Nenhuma atividade encontrada.</p>";
          return;
        }

        querySnapshot.forEach((doc) => {
          const atv = doc.data();
          const div = document.createElement("div");
          div.className = "atividade";
          div.innerHTML = `
            <strong>Descrição:</strong> ${atv.descricao}<br>
            <strong>Início:</strong> ${new Date(atv.inicio).toLocaleString()}<br>
            <strong>Fim:</strong> ${new Date(atv.fim).toLocaleString()}<br>
            <a href="${atv.url}" target="_blank">Abrir Formulário</a><br>
            <strong>QR Code:</strong><br>
            <img src="${atv.qrCodeUrl}" alt="QR Code da Atividade" style="max-width: 150px;">
            <button class="delete-btn" onclick="confirmarExclusao('${doc.id}')">Excluir</button>
          `;
          lista.appendChild(div);
        });
      } catch (error) {
        console.error("Erro ao carregar histórico:", error);
        lista.innerHTML = `<p class="error">Erro ao carregar histórico: ${error.message}</p>`;
      }
    }

    // Função para confirmar e excluir uma atividade (mantenha a sua)
    async function confirmarExclusao(docId) {
      const confirmar = confirm("Tem certeza de que deseja excluir esta atividade?");
      if (confirmar) {
        try {
          await db.collection("historico").doc(docId).delete();
          console.log("Atividade excluída com sucesso:", docId);
          mostrarHistorico(); // Atualiza o histórico após exclusão
        } catch (error) {
          console.error("Erro ao excluir atividade:", error);
          alert("Erro ao excluir atividade: " + error.message);
        }
      }
    }
  </script>
</body>
</html>
