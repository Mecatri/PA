<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de QR Code - Atividades</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        h2, h3 { text-align: center; }
        #container-qrcode { position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.8); padding: 8px; border-radius: 4px; box-shadow: 1px 1px 3px rgba(0,0,0,0.2); font-size: 0.9em; }
        label { display: block; margin-top: 10px; width: 100%; }
        input, textarea {
            width: calc(100% - 16px);
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            margin-top: 5px;
            padding: 10px 15px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        #qrcode { margin-top: 20px; text-align: center; }
        #historico { margin-top: 30px; width: 100%; }
        #listaAtividades { margin-top: 10px; }
        .atividade {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            text-align: left;
            width: 100%;
            box-sizing: border-box;
        }
        .atividade a { word-break: break-word; }
        .erro { color: red; margin-top: 10px; text-align: center; }
        .sucesso { color: green; margin-top: 10px; text-align: center; }
        .delete-btn {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 5px;
        }
        .delete-btn:hover { background-color: #c82333; }
        @media (max-width: 600px) {
            body { padding: 10px; }
            button { width: 100%; }
        }
    </style>
</head>
<body>
    <h2>Gerador de QR Code - Atividades</h2>
    <div id="app">
        <label for="descricao">Descri√ß√£o da Atividade:</label>
        <textarea id="descricao" rows="3" placeholder="Ex: Troca da v√°lvula CV-210"></textarea>

        <label for="observacoes">Observa√ß√µes</label>
        <textarea id="observacoes" rows="3" placeholder="Detalhes adicionais sobre a atividade"></textarea>

        <label for="inicio">Data e Hora de In√≠cio Prevista</label>
        <input type="datetime-local" id="inicio">

        <label for="fim">Data e Hora de T√©rmino Prevista</label>
        <input type="datetime-local" id="fim">

        <label for="ordemServico">Ordem de servi√ßo</label>
        <textarea id="ordemServico" rows="3" placeholder="Ex:1234"></textarea>

        <button onclick="gerarQR()">Gerar QR Code</button>

        <div id="qrcode"></div>
        <p id="mensagem" class="erro"></p>

        <div id="historico">
            <h3>üìã Hist√≥rico de Atividades Geradas</h3>
            <div id="listaAtividades"></div>
        </div>
    </div>
    <script>
        // Configura√ß√£o do Firebase (use a SUA config!)
        const firebaseConfig = {
            apiKey: "AIZA...SUACHAVE...",
            authDomain: "pa-pg-a7abc.firebaseapp.com",
            projectId: "pa-pg-a7abc",
            storageBucket: "pa-pg-a7abc.appspot.com",
            messagingSenderId: "102164980919",
            appId: "1:102164980919:web:72220a8b2ed478a2cdd932",
            clientId: "460190166657-18jb...etc.apps.googleusercontent.com"
        };
        firebase.initializeApp(firebaseConfig);

        const db = firebase.firestore();

        // Para identificar atividades de quem gerou, ser√° usado um "nome local"
        let nomeLocal = localStorage.getItem('nomeGerador') || '';
        if (!nomeLocal) {
            nomeLocal = prompt("Digite seu nome ou identifica√ß√£o para registrar as atividades:");
            localStorage.setItem('nomeGerador', nomeLocal || "An√¥nimo");
        }

        // Fun√ß√£o para gerar QR Code e salvar no Firestore
        async function gerarQR() {
            const descricao = document.getElementById("descricao").value.trim();
            const observacoes = document.getElementById("observacoes").value.trim();
            const inicio = document.getElementById("inicio").value;
            const fim = document.getElementById("fim").value;
            const ordemServico = document.getElementById("ordemServico").value.trim();
            const mensagem = document.getElementById("mensagem");

            // Valida√ß√µes b√°sicas
            if (!descricao || !inicio || !fim) {
                mensagem.textContent = "Preencha todos os campos obrigat√≥rios!";
                return;
            }

            mensagem.textContent = "";

            // Gera o texto do QRCode
            const dados = { descricao, observacoes, inicio, fim, ordemServico, nomeGerador: nomeLocal, dataGeracao: new Date().toISOString() };
            const dadosTexto = JSON.stringify(dados);

            // Salva no Firestore
            try {
                const docRef = await db.collection("historico").add(dados);
                // Mostra o QR Code
                document.getElementById("qrcode").innerHTML = "";
                QRCode.toCanvas(document.getElementById("qrcode"), dadosTexto, { width: 200 }, function (error) {
                    if (error) mensagem.textContent = "Erro ao gerar QR Code: " + error;
                });
                mensagem.textContent = "Atividade salva e QR Code gerado!";
                mensagem.className = "sucesso";
                carregarHistorico();
            } catch (e) {
                mensagem.textContent = "Erro ao salvar atividade: " + e.message;
                mensagem.className = "erro";
            }
        }

        // Fun√ß√£o para mostrar hist√≥rico de atividades
        async function carregarHistorico() {
            const lista = document.getElementById("listaAtividades");
            lista.innerHTML = "";
            try {
                const snapshot = await db.collection("historico")
                    .where("nomeGerador", "==", nomeLocal)
                    .orderBy("dataGeracao", "desc")
                    .limit(20)
                    .get();
                if (snapshot.empty) {
                    lista.innerHTML = "<p>Nenhuma atividade encontrada.</p>";
                    return;
                }
                snapshot.forEach(doc => {
                    const atv = doc.data();
                    const div = document.createElement("div");
                    div.className = "atividade";
                    div.innerHTML = `
                        <strong>Descri√ß√£o:</strong> ${atv.descricao || ''}<br>
                        <strong>Observa√ß√µes:</strong> ${atv.observacoes || ''}<br>
                        <strong>In√≠cio:</strong> ${new Date(atv.inicio).toLocaleString()}<br>
                        <strong>Fim:</strong> ${new Date(atv.fim).toLocaleString()}<br>
                        <strong>Ordem Servi√ßo:</strong> ${atv.ordemServico || ''}<br>
                        <strong>Data Gera√ß√£o:</strong> ${new Date(atv.dataGeracao).toLocaleString()}<br>
                        <button class="delete-btn" onclick="excluirAtividade('${doc.id}')">Excluir</button>
                    `;
                    lista.appendChild(div);
                });
            } catch (e) {
                lista.innerHTML = `<p class="erro">Erro ao carregar hist√≥rico: ${e.message}</p>`;
            }
        }

        // Fun√ß√£o para excluir atividade
        async function excluirAtividade(docId) {
            if (confirm("Tem certeza de que deseja excluir esta atividade?")) {
                try {
                    await db.collection("historico").doc(docId).delete();
                    carregarHistorico();
                } catch (e) {
                    alert("Erro ao excluir: " + e.message);
                }
            }
        }

        // Carrega hist√≥rico ao abrir a p√°gina
        carregarHistorico();
    </script>
</body>
</html>
